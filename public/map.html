<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Map</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .marker-label {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        // extract clientId from hash: #clientId=...
        function getHashParam(name) {
            const match = location.hash.match(new RegExp(name + '=([^&]*)'));
            return match ? match[1] : null;
        }

        const clientId = getHashParam('clientId');

        if (!clientId) {
            document.getElementById('map').innerText = 'No Client ID provided';
        } else {
            const script = document.createElement('script');
            script.src = `https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=${clientId}`;
            script.async = true;
            script.onload = initMap;
            document.head.appendChild(script);
        }

        let map = null;
        let markers = [];

        function initMap() {
            if (!window.naver) return;

            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.5665, 126.9780),
                zoom: 14,
                scaleControl: false,
                logoControl: false,
                mapDataControl: false,
                zoomControl: true,
                zoomControlOptions: { position: naver.maps.Position.TOP_RIGHT }
            });

            // Signal parent that map is ready
            window.parent.postMessage({ type: 'MAP_READY' }, '*');
        }

        // Listen for data from parent
        window.addEventListener('message', (event) => {
            if (!event.data || !map || !window.naver) return;

            if (event.data.type === 'UPDATE_MARKERS') {
                const restaurants = event.data.paylod || []; // Typo fix: payload
                updateMarkers(event.data.payload);
            }
        });

        function updateMarkers(restaurants) {
            // Clear existing
            markers.forEach(m => m.setMap(null));
            markers = [];

            if (!restaurants || restaurants.length === 0) return;

            const bounds = new naver.maps.LatLngBounds();

            restaurants.forEach((rest, index) => {
                if (!rest.latitude || !rest.longitude) return;

                const position = new naver.maps.LatLng(rest.latitude, rest.longitude);
                bounds.extend(position);

                const markerHtml = `
                    <div style="position:relative; cursor:pointer;">
                        <div style="width:24px; height:24px; background:#4e5968; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:12px; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                            ${index + 1}
                        </div>
                        <div class="marker-label">${rest.name}</div>
                    </div>
                `;

                const marker = new naver.maps.Marker({
                    position: position,
                    map: map,
                    icon: {
                        content: markerHtml,
                        size: new naver.maps.Size(30, 30),
                        anchor: new naver.maps.Point(15, 15)
                    }
                });

                markers.push(marker);
            });

            if (restaurants.length > 0) {
                map.fitBounds(bounds, { top: 40, right: 40, bottom: 40, left: 40 });
            }
        }
    </script>
</body>

</html>